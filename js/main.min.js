document.addEventListener(
  "DOMContentLoaded",
  () => {
    let d = $("body")
        .find("#downloadBFPSuccess")
        .children()
        .children()
        .children("p"),
      e = $("body")
        .find("#downloadBFPSuccess")
        .children()
        .children()
        .children("a"),
      o = setTimeout(() => {
        $("body")
          .addClass("modal-open")
          .find(".modal.fade")
          .addClass("show")
          .removeAttr("aria-hidden")
          .css("display", "block")
          .find(".modal-header")
          .find("h5")
          .text("ENQUIRE NOW");
        let d = $("body").find("#downloadBFPSuccess").children().children();
        d.children("p").remove(), d.children("a").remove();
      }, 2e3);
    $('[data-dismiss="modal"]').on("click", () => {
      $("body")
        .removeClass("modal-open")
        .find(".modal.fade")
        .removeClass("show")
        .attr("aria-hidden", !0)
        .css("display", "none")
        .find(".modal-header")
        .find("h5")
        .text("Submit Your Details to Download Brochure & Floor Plan");
      let n = $("body")
        .find("#downloadBFPSuccess")
        .children()
        .children()
        .children(".text-success");
      $("body").find("#downloadBFPSuccess").children().children().append(n, d),
        $("body")
          .find("#downloadBFPSuccess")
          .children()
          .children()
          .append(n, e),
        $('[data-dismiss="modal"]').off("click"),
        $(".downloadBFPForm").trigger("reset"),
        clearTimeout(o);
    });
  },
  !1
);

function clickEvent(first, last) {
  if (first.value.length) {
    document.getElementById(last).focus();
  }
}

function moveFocusBack(e, prev) {
  let prevInput = document.getElementById(prev);
  if (
    e.key === "Backspace" &&
    prevInput?.value != null &&
    e?.target?.value == ""
  ) {
    prevInput.focus();
  }
}

const optionLocation = {
  enableHighAccuracy: true,
  timeout: 10000,
  maximumAge: 0,
};

let data;

function detectLocation(e, check) {
  // document.querySelector(check ? "#detect" : "#FooterForm #detect").remove();
  // document.querySelector(
  //   check ? "#loading" : "#FooterForm #loading"
  // ).style.display = "block";
  document.querySelector(
    check == 1 ? ".detected1" : check == 2 ? ".detected2" : ".detected"
  ).innerHTML = "";
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        // delete data?.otp;
        let body = {
          token: data?.token,
          locationDto: {
            lat: position?.coords?.latitude,
            lng: position?.coords?.longitude,
          },
        };

        axios
          .post(`https://api-dcrm.fincity.com/open/opportunity/verify`, body)
          .then((res) => {
            document.querySelector(
              check == 1
                ? ".locationButton1"
                : check == 2
                ? ".locationButton2"
                : ".locationButton2"
            ).disabled = true;
            document.querySelector(
              check == 1
                ? ".detected1"
                : check == 2
                ? ".detected2"
                : ".detected"
            ).innerHTML = "Location Detected";
          })
          .catch((err) => {});
      },
      (error) => {
        // There was an error retrieving the location
        document.getElementById("detectText").innerText =
          "Failed to fetch Location!";
        document.getElementById("loading").style.display = "none";
      },
      optionLocation
    );
  } else {
    document.getElementById("loading").style.display = "none";
    document.getElementById("detectText").innerText =
      "Failed to fetch Location!";
  }
}

function backMain(e, check) {
  e.stopPropagation();

  document.querySelector(
    check ? "otpVerification" : "#FooterForm #otpVerification"
  ).style.display = "none";
  document.getElementById(
    check ? "downloadBFPForm" : "bookSiteVisitForm"
  ).style.display = "block";
  $(check ? ".downloadBFPStatus" : ".bookingStatus").html("");
  document.querySelector("#numberText").innerHTML =
    "Please Enter the Verification Code sent to";
  $(check ? "#DownloadFormModalTitle" : "bookSiteVisitFormTitle").html(
    "ENQUIRE NOW"
  );
}

function resendOtp(e) {
  e.stopPropagation();
  axios
    .post(
      `https://api-dcrm.fincity.com/open/opportunity/send-otp?token=${token}`
    )
    .then((res) => {
      document.querySelector("#resendOtp").innerText = "OTP SENT!";
      data = res;
    })
    .catch((err) => {});
}

function verifyOtp(e, check) {
  e.stopPropagation();
  let otp =
    document.querySelector(
      check == 1 ? "#_1st" : check == 2 ? "#_1st_" : "#__1st"
    )?.value +
    document.querySelector(
      check == 1 ? "#_2nd" : check == 2 ? "#_2nd_" : "#__2nd"
    )?.value +
    document.querySelector(
      check == 1 ? "#_3rd" : check == 2 ? "#_3rd_" : "#__3rd"
    )?.value +
    document.querySelector(
      check == 1 ? "#_4th" : check == 2 ? "#_4th_" : "#__4th"
    )?.value;
  let body = {
    token: data?.token,
    otp: otp,
  };

  axios
    .post(`https://api-dcrm.fincity.com/open/opportunity/verify`, body)
    .then((res) => {
      document.querySelector(
        check == 1
          ? ".otpVerification1"
          : check == 2
          ? ".otpVerification2"
          : ".otpVerification"
      ).style.display = "none";
      document.querySelector(
        check == 1 ? ".location1" : check == 2 ? ".location2" : ".location"
      ).style.display = "flex";
      setTimeout(() => {
        window.location.href = "https://dcrm.fincity.com/?&user=consumer";
      }, 5000);
    })
    .catch((err) => {});
}

function check() {
  let name = document.querySelector("#name");
  let phone = document.querySelector("#phone3");
  let email = document.querySelector("#email");
  let enquiryBtn = document.querySelector(".enquirBbutton");
  if (name.value !== "" && phone.value !== "" && email.value !== "") {
    enquiryBtn.disabled = false;
    enquiryBtn.style.backgroundColor = "#f2840d";
  } else {
    enquiryBtn.disabled = true;
    enquiryBtn.style.backgroundColor = "";
  }
}

let token;
let phoneNo;

function sendOtp() {
  let modalForm = document.querySelector(".enquiryMain");
  let verifyOtp = document.querySelector(".otpVerification");
  modalForm.style.display = "none";
  document.querySelector(".verfication-no").innerHTML = phoneNo;
  document.querySelector(".verfication-no2").innerHTML = phoneNo;
  document.querySelector(".verfication-no3").innerHTML = phoneNo;
  verifyOtp.style.display = "flex";
  axios
    .post(
      `https://api-dcrm.fincity.com/open/opportunity/send-otp?token=${token}`
    )
    .then((res) => {
      data = res?.data;
    })
    .catch((err) => {});
}

function gtag_report_conversion(url) {
  var callback = function () {
    if (typeof url != "undefined") {
      window.location = url;
    }
  };
  gtag("event", "conversion", {
    send_to: "AW-10852030635/wbYlCPr72JQYEKux07Yo",
    event_callback: callback,
  });
  return false;
}

function openApi(name, phone, email, count) {
  phoneNo = phone;
  let url = window.location.href;
  let searchParams = new URLSearchParams(new URL(url).search);
  utm_source = searchParams.get("utm_source");
  utm_campaign = searchParams.get("utm_campaign");
  utm_medium = searchParams.get("utm_medium");
  utm_content = searchParams.get("utm_content");
  utm_terms = searchParams.get("utm_terms");
  const isOtp = new URLSearchParams(new URL(url).search).get("isOTP");

  let body = {
    phone: phone,
    name: name,
    projectId: 24,
    // projectId: 103,
    email: email,
    ...(utm_campaign != null && { campaignCode: utm_campaign }),
    ...(searchParams?.entries?.length > 0 && {
      metadata: {
        utm_campaign: utm_campaign,
        utm_content: utm_content,
        utm_medium: utm_medium,
        utm_source: utm_source,
        utm_terms: utm_terms,
      },
    }),
    fromPortal: false,
    requireOtp: true,
  };
  axios
    .post("https://api-dcrm.fincity.com/open/opportunity", body)
    .then((res) => {
      gtag_report_conversion();
      if (isOtp) {
        let enquiryForm = document.querySelector(
          count == 1
            ? ".enquiryMain1"
            : count == 2
            ? ".enquiryMain2"
            : ".enquiryMain"
        );
        let verifyOtp = document.querySelector(
          count == 1
            ? ".otpVerification1"
            : count == 2
            ? ".otpVerification2"
            : ".otpVerification"
        );
        enquiryForm.style.display = "none";
        verifyOtp.style.display = "flex";
        token = res?.data?.token;
        sendOtp();
      } else {
        setTimeout(() => {
          window.location.href = "thankyou.html";
        }, 1000);
      }
    })
    .catch((error) => {});
}

function getInfo() {
  let name = document.querySelector("#name");
  let phone = document.querySelector("#phone3");
  let email = document.querySelector("#email");
  openApi(name.value, phone.value, email.value);
}

function changePhoneNo() {
  let modalForm = document.querySelector(".enquiryMain");
  let verifyOtp = document.querySelector(".otpVerification");
  modalForm.style.display = "flex";
  verifyOtp.style.display = "none";
}

function clickEvent(first, last) {
  if (first.value.length) {
    document.getElementById(last).focus();
  }
}

function moveFocusBack(e) {
  var prevInput = e.target.previousElementSibling;

  if (e.key === "Backspace" && e.target.value === "" && prevInput != null) {
    prevInput.focus();
  }
}

function inputChange1(e) {
  checkNew(e, 1);
}

function inputChange2(e) {
  checkNew(e, 2);
}

function inputChange3(e) {
  checkNew(e, 3);
}

function checkNew(e, count) {
  let name = document.querySelector(
    count == 1 ? "#name1" : count == 2 ? "#name2" : "#name"
  ).value;
  let phone = document.querySelector(
    count == 1 ? "#phone1" : count == 2 ? "#phone2" : "#phone"
  ).value;
  let email = document.querySelector(
    count == 1 ? "#email1" : count == 2 ? "#email2" : "#email"
  ).value;
  let checkboxValue = document.querySelector(
    count == 1 ? ".checkbox1" : count == 2 ? ".checkbox2" : ".checkbox"
  ).checked;
  let btn = document.querySelector(
    count == 1 ? ".getInfoBtn1" : count == 2 ? ".getInfoBtn2" : ".getInfoBtn"
  );
  if (name !== "" && phone !== "" && email !== "" && checkboxValue) {
    btn.disabled = false;
    btn.style.backgroundColor = "#D4A160";
  } else {
    btn.disabled = true;
    btn.style.backgroundColor = "#5F6F6D";
  }
}

function readMore(e, count) {
  e.stopPropagation();
  let lessText1 = document.querySelector(
    count == 1 ? ".lessText1" : count == 2 ? ".lessText2" : ".lessText"
  );
  let moreText1 = document.querySelector(
    count == 1 ? ".moreText1" : count == 2 ? ".moreText2" : ".moreText"
  );
  lessText1.style.display = "none";
  moreText1.style.display = "block";
}

function readLess(e, count) {
  e.stopPropagation();
  let lessText1 = document.querySelector(
    count == 1 ? ".lessText1" : count == 2 ? ".lessText2" : ".lessText"
  );
  let moreText1 = document.querySelector(
    count == 1 ? ".moreText1" : count == 2 ? ".moreText2" : ".moreText"
  );
  lessText1.style.display = "block";
  moreText1.style.display = "none";
}

function getInfo1(e, count) {
  e.stopPropagation();
  let name = document.querySelector(
    count == 1 ? "#name1" : count == 2 ? "#name2" : "#name"
  )?.value;
  let phone = document.querySelector(
    count == 1 ? "#phone1" : count == 2 ? "#phone2" : "#phone"
  )?.value;
  let email = document.querySelector(
    count == 1 ? "#email1" : count == 2 ? "#email2" : "#email"
  )?.value;
  openApi(name, phone, email, count);
}

function changePhoneNo1(e, count) {
  let enquiryForm = document.querySelector(
    count == 1 ? ".enquiryMain1" : count == 2 ? ".enquiryMain2" : ".enquiryMain"
  );
  let verifyOtp = document.querySelector(
    count == 1
      ? ".otpVerification1"
      : count == 2
      ? ".otpVerification2"
      : ".otpVerification"
  );
  verifyOtp.style.display = "none";
  enquiryForm.style.display = "flex";
}
